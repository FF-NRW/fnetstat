#!/bin/sh
# Netmon Nodewatcher (C) 2010-2011 Freifunk Oldenburg
# Update from Wermelskirchen by RubenKelevra 2012 - cyrond@gmail.com
# Lizenz: GPL
MESH_INTERFACE="br-freifunk"
ADHOC_INTERFACE="wlan0-1"
CLIENT_INTERFACE="wlan0"
BRCTL="/bin/brctl_ff"

echo "{"

echo "\"sys:script\": \"v0.5\","
echo "\"type\": \"daily\","
#hostnamen ausgeben
output=`cat /proc/sys/kernel/hostname`
echo "\"sys:hostname\": \"$output\","
#BATMAN MAC-Address
output=`ifconfig $ADHOC_INTERFACE | grep 'HWaddr' | awk '{ print $5}'`
echo "\"batman:mac\": \"$output\","
#AP MAC-Address
output=`ifconfig $CLIENT_INTERFACE | grep 'HWaddr' | awk '{ print $5}'`
echo "\"ap:mac\": \"$output\","

#uci lat/lon

output=`uci get system.@system[0].lat`
echo "\"sys:lat\": \"$output\","
output=`uci get system.@system[0].lon`
echo "\"sys:lon\": \"$output\","


#Mailkontaktadresse
output=`uci get system.@system[0].contact_mail`
echo "\"ap:contact:mail\": \"$output\","

#sysinfo hardware
output=`grep -m 1 "cpu model" /proc/cpuinfo | cut -d ":" -f 2`
echo "\"sys:cpu_model\": \"$output\","

output=`cat /tmp/sysinfo/model`
echo "\"sys:machine\": \"$output\","

output=`grep -m 1 "system type" /proc/cpuinfo | cut -d ":" -f 2`
echo "\"sys:system_type\": \"$output\","
#sysinfo software
echo -en "="
if which batctl >/dev/null; then
	output=`batctl -v | awk '{ print $2 }'`
	echo "\"sys:batman_version\": \"$output\","
else
	echo "\"batctl_missing\": \"yes\","
fi

output=`uname -r`


openwrt_version_file="/etc/openwrt_release"
if [ -f $openwrt_version_file ]; then
	. $openwrt_version_file
	echo "\"sys:distrib_id\": \"$DISTRIB_ID\","
	echo "\"sys:distrib_release\": \"$DISTRIB_RELEASE\","
fi

output=`cat /etc/firmware`
echo "\"sys:kernel_version\": \"$output\","

echo "}"